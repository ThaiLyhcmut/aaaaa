DataFlow Specification - Node-based Workflow Engine
Tổng quan
DataFlow là hệ thống workflow engine dựa trên graph, cho phép xây dựng các luồng xử lý phức tạp bằng cách kết nối các nodes với nhau. Mỗi node tự quản lý logic routing của riêng mình.

Cấu trúc tổng thể
interface DataFlow {  _id: string;  title: string;  outputEntity: string;  service: "Flow";  nodes: Node[];  result: ResultMapping;  options: FlowOptions;  method: HttpMethod;  module_name: string;  slug: string;  tenant_id: string;}

1. Node Interface
Base Node
Tất cả nodes đều kế thừa từ BaseNode:
interface BaseNode {  id: string;                    // ID duy nhất của node (dùng để reference trong context)  type: NodeType;                // Loại node  name: string;                  // Tên mô tả node  next?: string;                 // Next node (cho node thường)  onError?: ErrorHandler;        // Xử lý lỗi}
Ví dụ:
{  id: "check_course",  type: "core.findOne",  name: "Check course exists",  next: "check_permission"}

2. Service Types
DataFlow hỗ trợ nhiều loại services khác nhau. Service type được định nghĩa trong type field của node.
Service Naming Convention
{namespace}.{action}

Ví dụ:
- core.findOne          // Core database service
- redis.get             // Redis service
- elasticsearch.search  // Elasticsearch service
- custom.sendEmail      // Custom service
- webhook.post          // HTTP webhook
- queue.publish         // Message queue


3. Node Types by Service
3.1. Core Service (Database - MongoDB)
core.findOne - Tìm 1 document
interface TriggerNode extends BaseNode {  type: "trigger";  next: string;  // Required}
Ví dụ:
{  id: "start",  type: "trigger",  name: "Start flow",  next: "check_course"}

2.2. Database Query Nodes
core.findOne - Tìm 1 document
interface FindOneNode extends BaseNode {  type: "core.findOne";  entity: string;                // Tên entity/collection  queryMongorest: QueryObject;   // Query điều kiện  options?: QueryOptions;  next?: string;}
Ví dụ:
{  id: "check_course",  type: "core.findOne",  name: "Check course exists",  entity: "mge-courses",
  queryMongorest: {    _id: "@param:course_id",    status: "active"  },
  options: {    databaseType: "mongodb",    tenant_id: "@header:x-tenant-id"  },
  onError: {    action: "throw",    message: "Course not found",    statusCode: 404  },
  next: "check_permission"}
Context result:
context.check_course = {  _id: "xxx",  title: "Course ABC",  status: "active",  // ... tất cả fields từ DB}

core.findAll - Tìm nhiều documents
interface FindAllNode extends BaseNode {  type: "core.findAll";  entity: string;  queryMongorest: QueryObject;  options?: QueryOptions;  next?: string;}
Ví dụ:
{  id: "get_lessons",  type: "core.findAll",  entity: "mge-lessons",
  queryMongorest: {    course: "@context:check_course._id",    status: "active",    limit: 10,    skip: 0  },
  next: "process_lessons"}
Context result:
context.get_lessons = [  { _id: "1", title: "Lesson 1" },  { _id: "2", title: "Lesson 2" }]

core.count - Đếm documents
interface CountNode extends BaseNode {  type: "core.count";  entity: string;  queryMongorest: QueryObject;  options?: QueryOptions;  next?: string;}
Ví dụ:
{  id: "count_lessons",  type: "core.count",  entity: "mge-lessons",
  queryMongorest: {    course: "@context:check_course._id"  },
  next: "create_lesson"}
Context result:
context.count_lessons = {  count: 10}

core.aggregate - MongoDB aggregation
interface AggregateNode extends BaseNode {  type: "core.aggregate";  entity: string;  queryMongorest: {    pipeline: AggregationPipeline[];  };  options?: QueryOptions;  next?: string;}
Ví dụ:
{  id: "aggregate_stats",  type: "core.aggregate",  entity: "mge-lessons",
  queryMongorest: {    pipeline: [      {        $match: {          course: "@context:check_course._id"        }      },      {        $group: {          _id: "$lesson_type",          count: { $sum: 1 }        }      }    ]  },
  next: "process_stats"}

2.3. Mutation Nodes
core.create - Tạo mới document
interface CreateNode extends BaseNode {  type: "core.create";  entity: string;  data: DataMapping;          // Data để tạo  options?: QueryOptions;  next?: string;  switch?: SwitchRouting;     // Optional: routing theo kết quả}
Ví dụ:
{  id: "create_lesson",  type: "core.create",  entity: "mge-lessons",
  data: {    title: "@body:title",    slug: "@body:slug",    course: "@context:check_course._id",    order: "@context:count_lessons.count + 1",    status: "draft",    created_by: "@header:user.id",    tenant_id: "@header:x-tenant-id"  },
  options: {    databaseType: "mongodb"  },
  // Optional: routing theo lesson_type  switch: {    value: "@context:create_lesson.lesson_type",    cases: [      { case: "video", next: "process_video" },      { case: "quiz", next: "create_quiz" },      { case: "text", next: "send_notification" }    ],    default: "send_notification"  }}
Context result:
context.create_lesson = {  _id: "new_id",  title: "My Lesson",  slug: "my-lesson",  order: 11,  // ... tất cả fields vừa tạo}

core.update - Cập nhật document
interface UpdateNode extends BaseNode {  type: "core.update";  entity: string;  queryMongorest: QueryObject;  // Filter để tìm document cần update  data: DataMapping;            // Data để update  options?: QueryOptions;  next?: string;}
Ví dụ:
{  id: "update_course_stats",  type: "core.update",  entity: "mge-courses",
  queryMongorest: {    _id: "@context:check_course._id"  },
  data: {    $inc: { total_lessons: 1 },    updated_at: "@now",    updated_by: "@header:user.id"  },
  next: "send_notification"}

core.delete - Xóa document
interface DeleteNode extends BaseNode {  type: "core.delete";  entity: string;  queryMongorest: QueryObject;  options?: QueryOptions;  next?: string;}
Ví dụ:
{  id: "delete_lesson",  type: "core.delete",  entity: "mge-lessons",
  queryMongorest: {    _id: "@param:lesson_id",    created_by: "@header:user.id"  // Chỉ xóa lesson của mình  },
  next: "update_course_stats"}

core.createMany - Tạo nhiều documents
interface CreateManyNode extends BaseNode {  type: "core.createMany";  entity: string;  data: DataMapping | DataMapping[];  options?: QueryOptions;  next?: string;}
Ví dụ:
{  id: "create_questions",  type: "core.createMany",  entity: "mge-questions",
  data: {    lesson_id: "@context:create_lesson._id",    questions: "@body:questions"  // Array of questions  },
  next: "send_notification"}

3.2. Redis Service
redis.get - Lấy data từ Redis
interface RedisGetNode extends BaseNode {  type: "redis.get";  key: string;              // Redis key (hỗ trợ data binding)  options?: {    parse?: boolean;        // Parse JSON (default: true)  };  next?: string;}
Ví dụ:
{  id: "get_cache",  type: "redis.get",  name: "Get cached course data",
  key: "course:@param:course_id",
  options: {    parse: true  },
  onError: {    action: "fallback",    fallbackValue: null  },
  next: "check_cache_result"}
Context result:
context.get_cache = {  _id: "course_id",  title: "Cached Course",  // ... cached data}// hoặc null nếu không có cache

redis.set - Lưu data vào Redis
interface RedisSetNode extends BaseNode {  type: "redis.set";  key: string;  value: any;               // Data để lưu  options?: {    ttl?: number;           // Time to live (seconds)    stringify?: boolean;    // Convert to JSON (default: true)  };  next?: string;}
Ví dụ:
{  id: "cache_course",  type: "redis.set",  name: "Cache course data",
  key: "course:@context:check_course._id",  value: "@context:check_course",
  options: {    ttl: 3600,              // 1 hour    stringify: true  },
  onError: {    action: "continue"      // Không fail nếu cache lỗi  },
  next: "return_result"}

redis.del - Xóa key từ Redis
interface RedisDelNode extends BaseNode {  type: "redis.del";  keys: string | string[];  // Key hoặc array of keys  next?: string;}
Ví dụ:
{  id: "clear_cache",  type: "redis.del",  name: "Clear course cache",
  keys: [    "course:@param:course_id",    "lessons:@param:course_id",    "stats:@param:course_id"  ],
  next: "update_database"}

redis.incr / redis.decr - Tăng/giảm counter
interface RedisIncrNode extends BaseNode {  type: "redis.incr" | "redis.decr";  key: string;  amount?: number;          // Default: 1  next?: string;}
Ví dụ:
{  id: "increment_view_count",  type: "redis.incr",  name: "Increment lesson view count",
  key: "views:lesson:@param:lesson_id",  amount: 1,
  next: "return_result"}
Context result:
context.increment_view_count = {  value: 125  // Giá trị sau khi increment}

3.3. Elasticsearch Service
elasticsearch.search - Tìm kiếm trong Elasticsearch
interface ElasticsearchSearchNode extends BaseNode {  type: "elasticsearch.search";  index: string;            // Index name  query: any;               // Elasticsearch query DSL  options?: {    from?: number;    size?: number;    sort?: any;  };  next?: string;}
Ví dụ:
{  id: "search_lessons",  type: "elasticsearch.search",  name: "Search lessons",
  index: "lessons",
  query: {    bool: {      must: [        {          match: {            title: "@param:keyword"          }        },        {          term: {            course_id: "@param:course_id"          }        }      ]    }  },
  options: {    from: 0,    size: 20,    sort: [{ created_at: "desc" }]  },
  next: "format_results"}
Context result:
context.search_lessons = {  total: 15,  hits: [    { _id: "1", _source: { title: "Lesson 1", ... } },    { _id: "2", _source: { title: "Lesson 2", ... } }  ]}

elasticsearch.index - Index document
interface ElasticsearchIndexNode extends BaseNode {  type: "elasticsearch.index";  index: string;  id?: string;              // Document ID (optional)  document: any;            // Document to index  next?: string;}
Ví dụ:
{  id: "index_lesson",  type: "elasticsearch.index",  name: "Index lesson to search",
  index: "lessons",  id: "@context:create_lesson._id",
  document: {    title: "@context:create_lesson.title",    description: "@context:create_lesson.description",    course_id: "@context:create_lesson.course",    created_at: "@context:create_lesson.created_at"  },
  onError: {    action: "continue"  },
  next: "send_notification"}

elasticsearch.delete - Xóa document
interface ElasticsearchDeleteNode extends BaseNode {  type: "elasticsearch.delete";  index: string;  id: string;  next?: string;}
Ví dụ:
{  id: "delete_from_search",  type: "elasticsearch.delete",  name: "Remove from search index",
  index: "lessons",  id: "@param:lesson_id",
  next: "delete_from_db"}

3.4. Queue Service (BullMQ, RabbitMQ)
queue.publish - Đẩy job vào queue
interface QueuePublishNode extends BaseNode {  type: "queue.publish";  queue: string;            // Queue name  job: {    name: string;           // Job name    data: any;              // Job data    options?: {      delay?: number;       // Delay (ms)      attempts?: number;    // Retry attempts      priority?: number;    // Job priority    };  };  next?: string;}
Ví dụ:
{  id: "queue_video_process",  type: "queue.publish",  name: "Queue video processing",
  queue: "video-processing",
  job: {    name: "process-video",    data: {      lesson_id: "@context:create_lesson._id",      video_url: "@body:video_url",      quality: ["720p", "1080p"]    },    options: {      delay: 0,      attempts: 3,      priority: 1    }  },
  next: "return_success"}
Context result:
context.queue_video_process = {  jobId: "12345",  queue: "video-processing",  status: "queued"}

queue.consume - Xử lý job từ queue (worker)
interface QueueConsumeNode extends BaseNode {  type: "queue.consume";  queue: string;  handler: string;          // Handler function name  concurrency?: number;     // Số jobs chạy đồng thời}
Ví dụ (Worker flow):
{  id: "consume_video_jobs",  type: "queue.consume",  name: "Process video jobs",
  queue: "video-processing",  handler: "processVideoJob",  concurrency: 5,
  next: "process_video"}

3.5. HTTP/Webhook Service
http.get - HTTP GET request
interface HttpGetNode extends BaseNode {  type: "http.get";  url: string;  headers?: Record<string, string>;  params?: Record<string, any>;  options?: {    timeout?: number;    validateStatus?: (status: number) => boolean;  };  next?: string;}
Ví dụ:
{  id: "fetch_external_data",  type: "http.get",  name: "Fetch data from external API",
  url: "https://api.external.com/courses/@param:course_id",
  headers: {    "Authorization": "Bearer @env:API_TOKEN",    "Content-Type": "application/json"  },
  params: {    include: "lessons,chapters"  },
  options: {    timeout: 10000  },
  onError: {    action: "fallback",    fallbackValue: null  },
  next: "merge_data"}
Context result:
context.fetch_external_data = {  status: 200,  data: {    id: "course_id",    title: "External Course",    // ... response data  }}

http.post - HTTP POST request
interface HttpPostNode extends BaseNode {  type: "http.post";  url: string;  headers?: Record<string, string>;  body: any;  options?: {    timeout?: number;  };  next?: string;}
Ví dụ:
{  id: "webhook_notification",  type: "http.post",  name: "Send webhook notification",
  url: "@context:check_course.webhook_url",
  headers: {    "Content-Type": "application/json",    "X-Signature": "@computed:signature"  },
  body: {    event: "lesson.created",    data: {      lesson_id: "@context:create_lesson._id",      lesson_title: "@context:create_lesson.title",      course_id: "@context:check_course._id"    },    timestamp: "@now"  },
  options: {    timeout: 5000  },
  onError: {    action: "continue",    log: true  },
  next: "end"}

3.6. Email Service
email.send - Gửi email
interface EmailSendNode extends BaseNode {  type: "email.send";  template?: string;        // Template name  to: string | string[];  subject?: string;  data?: any;               // Template data  options?: {    from?: string;    cc?: string[];    bcc?: string[];    attachments?: Array<{      filename: string;      path: string;    }>;  };  next?: string;}
Ví dụ:
{  id: "send_welcome_email",  type: "email.send",  name: "Send welcome email",
  template: "course-welcome",
  to: "@context:get_course_members[].email",
  subject: "New lesson in @context:check_course.title",
  data: {    course_title: "@context:check_course.title",    lesson_title: "@context:create_lesson.title",    lesson_url: "https://example.com/lessons/@context:create_lesson._id",    user_name: "@context:get_course_members[].name"  },
  options: {    from: "noreply@example.com"  },
  onError: {    action: "continue",    log: true  },
  next: "end"}
Context result:
context.send_welcome_email = {  sent: true,  messageId: "msg_12345",  recipients: 25}

3.7. File Storage Service
storage.upload - Upload file
interface StorageUploadNode extends BaseNode {  type: "storage.upload";  bucket?: string;  file: {    buffer?: string;        // Base64 buffer    path?: string;          // Local file path    url?: string;           // URL to download  };  destination: string;      // Destination path  options?: {    contentType?: string;    public?: boolean;    metadata?: Record<string, string>;  };  next?: string;}
Ví dụ:
{  id: "upload_lesson_thumbnail",  type: "storage.upload",  name: "Upload lesson thumbnail",
  bucket: "lesson-thumbnails",
  file: {    buffer: "@body:thumbnail_base64"  },
  destination: "lessons/@context:create_lesson._id/thumbnail.jpg",
  options: {    contentType: "image/jpeg",    public: true,    metadata: {      lesson_id: "@context:create_lesson._id",      uploaded_by: "@header:user.id"    }  },
  next: "update_lesson_thumbnail_url"}
Context result:
context.upload_lesson_thumbnail = {  url: "https://cdn.example.com/lessons/xxx/thumbnail.jpg",  size: 45678,  contentType: "image/jpeg"}

3.8. Notification Service
notification.push - Gửi push notification
interface NotificationPushNode extends BaseNode {  type: "notification.push";  users: string | string[];     // User IDs  notification: {    title: string;    body: string;    icon?: string;    data?: any;  };  options?: {    priority?: "high" | "normal";    ttl?: number;  };  next?: string;}
Ví dụ:
{  id: "send_push_notification",  type: "notification.push",  name: "Send push to course members",
  users: "@context:get_course_members[].user_id",
  notification: {    title: "New Lesson Available",    body: "@context:create_lesson.title in @context:check_course.title",    icon: "@context:check_course.cover_image",    data: {      type: "new_lesson",      lesson_id: "@context:create_lesson._id",      course_id: "@context:check_course._id"    }  },
  options: {    priority: "high",    ttl: 86400  },
  onError: {    action: "continue"  },
  next: "end"}

3.9. Analytics Service
analytics.track - Track event
interface AnalyticsTrackNode extends BaseNode {  type: "analytics.track";  event: string;  properties?: any;  userId?: string;  next?: string;}
Ví dụ:
{  id: "track_lesson_created",  type: "analytics.track",  name: "Track lesson creation",
  event: "Lesson Created",
  properties: {    lesson_id: "@context:create_lesson._id",    lesson_title: "@context:create_lesson.title",    lesson_type: "@context:create_lesson.lesson_type",    course_id: "@context:check_course._id",    course_title: "@context:check_course.title"  },
  userId: "@header:user.id",
  onError: {    action: "continue"  },
  next: "end"}

3.10. AI/ML Service
ai.completion - GPT completion
interface AICompletionNode extends BaseNode {  type: "ai.completion";  provider: "openai" | "anthropic";  model: string;  prompt: string;  options?: {    temperature?: number;    maxTokens?: number;    systemPrompt?: string;  };  next?: string;}
Ví dụ:
{  id: "generate_lesson_summary",  type: "ai.completion",  name: "Generate lesson summary",
  provider: "openai",  model: "gpt-4",
  prompt: "Summarize this lesson content:\n\n@context:create_lesson.description",
  options: {    temperature: 0.7,    maxTokens: 500,    systemPrompt: "You are a helpful educational assistant."  },
  next: "update_lesson_summary"}
Context result:
context.generate_lesson_summary = {  content: "This lesson covers...",  tokens: 125,  model: "gpt-4"}

3.11. Payment Service
payment.createCharge - Tạo payment charge
interface PaymentChargeNode extends BaseNode {  type: "payment.createCharge";  provider: "stripe" | "paypal";  amount: number;  currency: string;  customerId: string;  metadata?: any;  next?: string;}
Ví dụ:
{  id: "charge_course_payment",  type: "payment.createCharge",  name: "Charge for course enrollment",
  provider: "stripe",  amount: "@context:check_course.price",  currency: "USD",  customerId: "@context:get_user.stripe_customer_id",
  metadata: {    course_id: "@context:check_course._id",    user_id: "@header:user.id",    type: "course_enrollment"  },
  onError: {    action: "throw",    message: "Payment failed",    statusCode: 402  },
  next: "create_enrollment"}
Context result:
context.charge_course_payment = {  id: "ch_12345",  amount: 4999,  status: "succeeded",  receipt_url: "https://stripe.com/receipts/xxx"}

3.12. Custom Service
Bạn có thể tạo custom service của riêng mình:
interface CustomServiceNode extends BaseNode {  type: string;             // custom.{yourServiceName}  data?: any;  options?: any;  next?: string;}
Ví dụ:
{  id: "custom_process",  type: "custom.myCustomService",  name: "My custom processing",
  data: {    input: "@context:some_node.output",    config: "@param:config"  },
  options: {    timeout: 30000  },
  next: "next_step"}
Để implement custom service, tạo file trong src/services/custom/:
// src/services/custom/myCustomService.tsexport async function myCustomService(data: any, options: any, context: any) {  // Your custom logic here
  return {    result: "success",    data: processedData  };}

3.13. Combining Multiple Services
Flow có thể kết hợp nhiều services:
{  nodes: [    {      id: "start",      type: "trigger",      next: "check_cache"    },
    // Check Redis cache    {      id: "check_cache",      type: "redis.get",      key: "course:@param:course_id",      next: "cache_condition"    },
    // Route based on cache    {      id: "cache_condition",      type: "condition",      condition: {        if: "@context:check_cache != null",        then: "return_cached",        else: "fetch_from_db"      }    },
    // Fetch from MongoDB    {      id: "fetch_from_db",      type: "core.findOne",      entity: "mge-courses",      queryMongorest: {        _id: "@param:course_id"      },      next: "parallel_enrich"    },
    // Parallel: Elasticsearch search + External API    {      id: "parallel_enrich",      type: "parallel",      parallel: [        "search_similar",        "fetch_external_data",        "cache_result"      ],      next: "track_analytics"    },
    {      id: "search_similar",      type: "elasticsearch.search",      index: "courses",      query: {        more_like_this: {          fields: ["title", "description"],          like: "@context:fetch_from_db.title"        }      }    },
    {      id: "fetch_external_data",      type: "http.get",      url: "https://api.external.com/enrichment/@param:course_id"    },
    {      id: "cache_result",      type: "redis.set",      key: "course:@param:course_id",      value: "@context:fetch_from_db",      options: {        ttl: 3600      }    },
    // Track analytics    {      id: "track_analytics",      type: "analytics.track",      event: "Course Viewed",      properties: {        course_id: "@param:course_id"      },      next: "send_notification"    },
    // Queue notification    {      id: "send_notification",      type: "queue.publish",      queue: "notifications",      job: {        name: "send-view-notification",        data: {          user_id: "@header:user.id",          course_id: "@param:course_id"        }      },      next: "end"    },
    {      id: "return_cached",      type: "output"    },
    {      id: "end",      type: "output"    }  ]}

2.4. Logic Nodes
Switch Node - Nhiều nhánh (như switch-case)
interface SwitchNode extends BaseNode {  type: "switch";  switch: {    value: string;              // Giá trị để switch (hỗ trợ @context, @param, @body...)    cases: SwitchCase[];        // Danh sách cases    default: string;            // Default next nếu không match case nào  };}
interface SwitchCase {  case: string | number | boolean;  // Giá trị để so sánh  next: string;                      // Next node nếu match}
Ví dụ:
{  id: "check_course_type",  type: "switch",  name: "Route by course type",
  switch: {    value: "@context:check_course.type",    cases: [      { case: "premium", next: "check_payment" },      { case: "free", next: "check_permission" },      { case: "trial", next: "check_trial_limit" }    ],    default: "check_permission"  }}
Visualization:
[check_course_type]
    ↓ switch(@context:check_course.type)
    ├─ "premium" → [check_payment]
    ├─ "free" → [check_permission]
    ├─ "trial" → [check_trial_limit]
    └─ default → [check_permission]


Condition Node - If-Else
interface ConditionNode extends BaseNode {  type: "condition";  condition: {    if: string;        // Expression điều kiện    then: string;      // Next node nếu true    else: string;      // Next node nếu false  };}
Ví dụ:
{  id: "check_trial_limit",  type: "condition",  name: "Check trial lessons limit",
  condition: {    if: "@context:count_lessons.count < 3",    then: "create_lesson",    else: "trial_limit_exceeded"  }}
Supported expressions:
// So sánh số"@context:count.total < 10""@context:count.total >= 5""@context:count.total == 0"
// So sánh string"@context:user.role == 'admin'""@context:course.type != 'premium'"
// So sánh boolean"@context:settings.enabled == true""@context:course.is_public == false"
// Null check"@context:payment != null""@context:payment == null"
// Logic operators"@context:count.total > 0 && @context:user.role == 'admin'""@context:course.type == 'free' || @context:payment != null"

Parallel Node - Chạy song song
interface ParallelNode extends BaseNode {  type: "parallel";  parallel: string[];     // Array of node IDs chạy song song  next: string;          // Next node sau khi TẤT CẢ parallel nodes xong}
Ví dụ:
{  id: "parallel_fetch",  type: "parallel",  name: "Fetch data in parallel",
  parallel: [    "count_chapters",    "count_lessons",    "check_permission"  ],
  next: "create_lesson"  // Chạy sau khi cả 3 nodes trên xong}
// Định nghĩa các nodes trong parallel{  id: "count_chapters",  type: "core.count",  entity: "mge-chapters",  queryMongorest: {    course: "@context:check_course._id"  }  // Không có next vì nó là child của parallel node},{  id: "count_lessons",  type: "core.count",  entity: "mge-lessons",  queryMongorest: {    course: "@context:check_course._id"  }  // Không có next},{  id: "check_permission",  type: "core.findOne",  entity: "mge-course-member",  queryMongorest: {    user: "@header:user.id",    course: "@context:check_course._id"  }  // Không có next}
Visualization:
[parallel_fetch]
    ├─ [count_chapters] ─┐
    ├─ [count_lessons] ──┤ (chạy đồng thời)
    └─ [check_permission]┘
            ↓ (chờ tất cả xong)
      [create_lesson]

Lưu ý:

Các nodes trong parallel array chạy đồng thời
Parent node chờ TẤT CẢ child nodes hoàn thành
Nếu 1 child node fail (và onError.action = "throw") → parent fail


2.5. Special Nodes
Error Node - Throw error và stop flow
interface ErrorNode extends BaseNode {  type: "error";  error: {    message: string;    statusCode: number;    data?: any;  };  // Không có next vì flow dừng tại đây}
Ví dụ:
{  id: "permission_denied",  type: "error",  name: "Permission denied",
  error: {    message: "You don't have permission to create lesson",    statusCode: 403,    data: {      required_role: "instructor",      current_role: "@context:check_permission.role"    }  }}

Output Node - Kết thúc flow
interface OutputNode extends BaseNode {  type: "output";  // Không có next vì đây là node cuối}
Ví dụ:
{  id: "end",  type: "output",  name: "Return result"}

2.6. Custom Nodes
Custom Service Node
interface CustomNode extends BaseNode {  type: string;  // custom.{serviceName}  data?: DataMapping;  options?: any;  next?: string;}
Ví dụ:
{  id: "send_email",  type: "custom.sendEmail",  name: "Send email notification",
  data: {    template: "new_lesson",    to: "@context:get_course_members",    subject: "New lesson: @context:create_lesson.title",    data: {      lesson_title: "@context:create_lesson.title",      course_title: "@context:check_course.title",      lesson_url: "https://example.com/lessons/@context:create_lesson._id"    }  },
  onError: {    action: "continue"  // Không fail flow nếu email lỗi  },
  next: "end"}
{  id: "process_video",  type: "custom.processVideo",  name: "Process video upload",
  data: {    lesson_id: "@context:create_lesson._id",    video_url: "@body:video_url",    quality: ["720p", "1080p"]  },
  options: {    timeout: 300000  // 5 minutes  },
  next: "send_notification"}

3. Error Handling
interface ErrorHandler {  action: "throw" | "continue" | "fallback";  message?: string;  statusCode?: number;  fallbackValue?: any;      // Chỉ dùng khi action = "fallback"  log?: boolean;            // Log error ra console/file}
3.1. Throw Error (Default)
Stop flow và throw error ra ngoài.
{  id: "check_course",  type: "core.findOne",  entity: "mge-courses",
  queryMongorest: {    _id: "@param:course_id"  },
  onError: {    action: "throw",    message: "Course not found",    statusCode: 404  },
  next: "check_permission"}
Behavior:

Node fail → Throw error
Flow dừng
Transaction rollback (nếu enabled)
Return error response


3.2. Continue (Ignore Error)
Log error nhưng tiếp tục flow, context node = null.
{  id: "send_notification",  type: "core.create",  entity: "notification-record",
  data: {    message: "New lesson created"  },
  onError: {    action: "continue",    log: true  },
  next: "end"}
Behavior:

Node fail → Log error
Context: context.send_notification = null
Flow tiếp tục chạy next node


3.3. Fallback (Default Value)
Nếu fail thì trả về fallback value.
{  id: "count_lessons",  type: "core.count",  entity: "mge-lessons",
  queryMongorest: {    course: "@context:check_course._id"  },
  onError: {    action: "fallback",    fallbackValue: { count: 0 }  },
  next: "create_lesson"}
Behavior:

Node fail → Không throw error
Context: context.count_lessons = { count: 0 }
Flow tiếp tục


4. Data Binding Syntax
4.1. Sources
// From URL params"@param:course_id""@param:_id"
// From request body"@body:title""@body:description"
// From request headers"@header:user.id""@header:x-tenant-id"
// From context (previous nodes)"@context:check_course._id""@context:count_lessons.count""@context:check_permission.role"
// From loop context"@loop:currentIndex""@loop:current._id""@loop:items.length"
// Special values"@now"              // Current timestamp"@uuid"             // Generate UUID"@tenant_id"        // Current tenant ID

4.2. Nested Access
// Nested object"@context:check_course.created_by._id""@context:get_user.profile.avatar.url"
// Array access"@context:get_lessons[0].title""@context:get_users[0]._id"
// Array length"@context:get_lessons.length"

4.3. Computed Expressions
// Math operations"@context:count_lessons.count + 1""@context:price.amount * 0.9""@context:total.value - @context:discount.amount"
// String concatenation"@context:user.first_name + ' ' + @context:user.last_name""New lesson: @context:create_lesson.title"
// Ternary operator"@context:course.type == 'premium' ? 'paid' : 'free'"

5. Query Options
interface QueryOptions {  databaseType?: "mongodb" | "postgresql" | "mysql";  tenant_id?: string;  select?: string[];         // Fields to select  populate?: string[];       // Relations to populate  sort?: Record<string, 1 | -1>;  limit?: number;  skip?: number;  cache?: {    enabled: boolean;    ttl: number;             // seconds    key?: string;  };}
Ví dụ:
{  id: "get_lessons",  type: "core.findAll",  entity: "mge-lessons",
  queryMongorest: {    course: "@context:check_course._id",    status: "active"  },
  options: {    databaseType: "mongodb",    tenant_id: "@header:x-tenant-id",    select: ["title", "slug", "order", "created_at"],    populate: ["created_by", "chapter"],    sort: { order: 1 },    limit: 10,    skip: 0,    cache: {      enabled: true,      ttl: 300,      key: "lessons:@context:check_course._id"    }  },
  next: "process_lessons"}

6. Result Mapping
Định nghĩa cấu trúc dữ liệu trả về từ flow.
interface ResultMapping {  [key: string]: string | ResultMapping;}
Ví dụ:
result: {  // Simple mapping  _id: "@context:create_lesson._id",  title: "@context:create_lesson.title",  slug: "@context:create_lesson.slug",
  // Nested object  course: {    _id: "@context:check_course._id",    title: "@context:check_course.title",    type: "@context:check_course.type"  },
  // Computed values  order: "@context:create_lesson.order",  total_lessons: "@context:count_lessons.count + 1",
  // Array mapping  chapters: "@context:get_chapters",
  // Metadata  meta: {    created_at: "@context:create_lesson.created_at",    created_by: "@context:create_lesson.created_by",    execution_time: "@flow:execution_time"  }}
Output:
{  "_id": "lesson_id",  "title": "My Lesson",  "slug": "my-lesson",  "course": {    "_id": "course_id",    "title": "Course ABC",    "type": "premium"  },  "order": 11,  "total_lessons": 11,  "chapters": [...],  "meta": {    "created_at": "2025-01-15T10:00:00Z",    "created_by": "user_id",    "execution_time": 1250  }}

7. Flow Options
interface FlowOptions {  transaction?: boolean;           // Enable transaction  transactionType?: string;        // mongodb | postgresql  timeout?: number;                // Flow timeout (ms)  logging?: boolean;               // Enable logging  logLevel?: "debug" | "info" | "warn" | "error";  startNode?: string;              // Start node ID (default: "start")  maxParallelNodes?: number;       // Max parallel nodes (default: 10)  retry?: {    enabled: boolean;    maxAttempts: number;    backoff: "linear" | "exponential";  };}
Ví dụ:
options: {  transaction: true,  transactionType: "mongodb",  timeout: 30000,              // 30 seconds  logging: true,  logLevel: "info",  startNode: "start",  maxParallelNodes: 5,  retry: {    enabled: false,    maxAttempts: 3,    backoff: "exponential"  }}

8. Context Management
Context là object chứa kết quả của tất cả nodes đã chạy.
8.1. Context Structure
context = {  // Node ID là key, result là value  check_course: {    _id: "course_id",    title: "Course ABC",    type: "premium",    // ... all fields from DB  },
  count_chapters: {    count: 5  },
  count_lessons: {    count: 10  },
  check_permission: {    _id: "member_id",    role: "instructor",    status: "joined"  },
  create_lesson: {    _id: "new_lesson_id",    title: "My Lesson",    slug: "my-lesson",    order: 11,    // ... all created fields  }}
8.2. Context Access
// Trong node khác, access context qua syntax:"@context:{node_id}.{field}"
// Ví dụ:{  id: "create_lesson",  type: "core.create",  data: {    course: "@context:check_course._id",        // "course_id"    order: "@context:count_lessons.count + 1",  // 11    instructor: "@context:check_permission.user._id"  }}
8.3. Context Lifetime

Context được khởi tạo khi flow bắt đầu
Mỗi node hoàn thành → result lưu vào context
Context được giữ trong suốt flow execution
Context bị clear sau khi flow kết thúc


9. Conditional Node Execution
Node có thể có điều kiện thực thi riêng:
interface ConditionalExecution {  if: string;           // Expression điều kiện  then: string | null;  // null = chạy node này  else: string;         // "skip" = skip node, hoặc node_id khác}
Ví dụ:
{  id: "send_email",  type: "custom.sendEmail",
  data: {    template: "new_lesson",    to: "@context:get_members"  },
  // Chỉ chạy nếu email_enabled = true  condition: {    if: "@context:check_course.settings.email_enabled == true",    then: null,     // Chạy node này    else: "skip"    // Skip sang next node  },
  next: "send_notification"}
Behavior:

Nếu condition = true → Chạy node
Nếu condition = false → Skip node, nhảy thẳng sang next


10. Advanced Features
10.1. Loop Support
{  nodes: [    {      id: "init_loop",      type: "loop.init",      loop: {        items: "@context:get_users",        currentIndex: 0,        maxIterations: 1000      },      next: "loop_condition"    },
    {      id: "loop_condition",      type: "condition",      condition: {        if: "@loop:currentIndex < @loop:items.length",        then: "process_item",        else: "end_loop"      }    },
    {      id: "process_item",      type: "core.update",      entity: "users",      queryMongorest: {        _id: "@loop:current._id"      },      data: {        processed: true      },      next: "loop_next"    },
    {      id: "loop_next",      type: "loop.next",      next: "loop_condition"    },
    {      id: "end_loop",      type: "loop.end",      next: "finish"    }  ]}

10.2. Sub-Flow Support
Gọi flow khác như 1 node:
{  id: "create_course_member",  type: "flow.call",  flow: "add-course-member",  // Slug của flow khác
  data: {    course_id: "@context:check_course._id",    user_id: "@header:user.id",    role: "student"  },
  next: "send_welcome_email"}

10.3. Webhook Node
{  id: "call_external_api",  type: "webhook",
  webhook: {    url: "https://api.external.com/notify",    method: "POST",    headers: {      "Authorization": "Bearer @env:API_TOKEN",      "Content-Type": "application/json"    },    body: {      event: "lesson_created",      lesson_id: "@context:create_lesson._id",      course_id: "@context:check_course._id"    },    timeout: 10000  },
  onError: {    action: "continue"  },
  next: "end"}

11. Best Practices
11.1. Naming Conventions
// Node IDs: snake_case, mô tả actionid: "check_course"id: "create_lesson"id: "send_notification"
// Node names: Human readablename: "Check course exists"name: "Create new lesson"name: "Send notification to members"

11.2. Error Handling Strategy
// Critical nodes: throw error{  id: "check_permission",  type: "core.findOne",  onError: {    action: "throw",    statusCode: 403  }}
// Non-critical nodes: continue{  id: "send_notification",  type: "core.create",  onError: {    action: "continue",    log: true  }}
// Optional data: fallback{  id: "get_settings",  type: "core.findOne",  onError: {    action: "fallback",    fallbackValue: { enabled: false }  }}

11.3. Parallel Optimization
Chạy song song các nodes độc lập:
// ❌ Bad: Chạy tuần tự{  id: "count_chapters",  next: "count_lessons"},{  id: "count_lessons",  next: "check_permission"},{  id: "check_permission",  next: "create_lesson"}
// ✅ Good: Chạy song song{  id: "parallel_fetch",  type: "parallel",  parallel: [    "count_chapters",    "count_lessons",    "check_permission"  ],  next: "create_lesson"}

11.4. Transaction Usage
// Enable transaction cho operations quan trọngoptions: {  transaction: true,  transactionType: "mongodb"}
// Nếu bất kỳ node nào fail → Rollback tất cả

12. Complete Example
Xem file /home/thaily/code/old/cli/mangoads/src/js/response-test/create-lesson-flow.ts để có ví dụ đầy đủ.

13. Testing & Debugging
13.1. Debug Mode
options: {  logging: true,  logLevel: "debug"}
Output:
[Flow] Starting flow: create-lesson
[Node] Executing: check_course
[Node] Result: { _id: "xxx", title: "Course ABC" }
[Node] Executing: parallel_fetch
  [Node] Executing: count_chapters (parallel)
  [Node] Executing: count_lessons (parallel)
  [Node] Executing: check_permission (parallel)
[Node] Parallel completed: 3 nodes
[Node] Executing: create_lesson
[Node] Result: { _id: "yyy", title: "My Lesson" }
[Flow] Completed in 1250ms


13.2. Context Inspection
Trong development, có thể inspect context:
result: {  // ... normal result
  // Debug info  _debug: {    context: "@flow:context",    execution_time: "@flow:execution_time",    nodes_executed: "@flow:nodes_executed"  }}

14. Migration từ hệ thống cũ
Từ simple response sang DataFlow:
Trước:
{  outputEntity: "mge-lessons",  queryAdvance: "...",  method: "post"}
Sau:
{  service: "Flow",  nodes: [    {      id: "start",      type: "trigger",      next: "create_lesson"    },    {      id: "create_lesson",      type: "core.create",      entity: "mge-lessons",      data: { /* ... */ },      next: "end"    },    {      id: "end",      type: "output"    }  ],  result: { /* ... */ }}

Tài liệu tham khảo

README-lesson.md - Role settings & validation
Examples: src/js/response-test/*-flow.ts
API Docs: docs/api-reference.md
